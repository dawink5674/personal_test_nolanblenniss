---
- block:
    - name: Install OpenVPN packages
      package:
        name:
          - openvpn
          - easy-rsa
          - iptables-persistent
        state: present
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Install ufw if enabled
      package:
        name: ufw
        state: present
      when: ufw_enabled | default(false)

    - name: Ensure Easy-RSA dir
      file:
        path: /etc/openvpn/easy-rsa
        state: directory
        mode: '0755'

    - name: Find Easy-RSA source directory
      shell: |
        if [ -d /usr/share/easy-rsa ]; then
          echo "/usr/share/easy-rsa"
        elif [ -f /usr/share/easy-rsa/easyrsa ]; then
          echo "/usr/share/easy-rsa"
        else
          find /usr -name "easyrsa" -type f 2>/dev/null | head -1 | xargs dirname
        fi
      register: easyrsa_source
      changed_when: false

    - name: Copy Easy-RSA files
      shell: |
        if [ -d "{{ easyrsa_source.stdout }}" ]; then
          cp -r {{ easyrsa_source.stdout }}/* /etc/openvpn/easy-rsa/
        fi
      args:
        creates: /etc/openvpn/easy-rsa/easyrsa

    - name: Make easyrsa executable
      file:
        path: /etc/openvpn/easy-rsa/easyrsa
        mode: '0755'
      failed_when: false

    - name: Create Easy-RSA vars file
      copy:
        content: |
          set_var EASYRSA_BATCH "yes"
          set_var EASYRSA_REQ_CN "OpenVPN-CA"
          set_var EASYRSA_REQ_COUNTRY "US"
          set_var EASYRSA_REQ_PROVINCE "State"
          set_var EASYRSA_REQ_CITY "City"
          set_var EASYRSA_REQ_ORG "MWCCDC"
          set_var EASYRSA_REQ_EMAIL "admin@localhost"
          set_var EASYRSA_REQ_OU "VPN"
          set_var EASYRSA_KEY_SIZE 2048
          set_var EASYRSA_ALGO rsa
          set_var EASYRSA_CA_EXPIRE 3650
          set_var EASYRSA_CERT_EXPIRE 3650
        dest: /etc/openvpn/easy-rsa/vars
        mode: '0644'

    - name: Check if PKI exists
      stat:
        path: /etc/openvpn/easy-rsa/pki/ca.crt
      register: pki_exists

    - name: Initialize PKI (clean start)
      shell: |
        cd /etc/openvpn/easy-rsa
        yes "" | ./easyrsa init-pki 2>/dev/null || ./easyrsa init-pki
      when: not pki_exists.stat.exists
      failed_when: false

    - name: Build CA
      shell: |
        cd /etc/openvpn/easy-rsa
        echo -e "\n" | ./easyrsa build-ca nopass 2>&1
      when: not pki_exists.stat.exists
      register: ca_result
      failed_when: false

    - name: Check CA was created
      stat:
        path: /etc/openvpn/easy-rsa/pki/ca.crt
      register: ca_check

    - name: Build CA (alternative method)
      shell: |
        cd /etc/openvpn/easy-rsa
        export EASYRSA_BATCH=1
        ./easyrsa --batch build-ca nopass
      when: not ca_check.stat.exists
      environment:
        EASYRSA_BATCH: "1"
      failed_when: false

    - name: Check if server cert exists
      stat:
        path: /etc/openvpn/easy-rsa/pki/issued/server.crt
      register: server_cert_exists

    - name: Build server certificate
      shell: |
        cd /etc/openvpn/easy-rsa
        ./easyrsa --batch build-server-full server nopass
      when: not server_cert_exists.stat.exists
      environment:
        EASYRSA_BATCH: "1"
      failed_when: false

    - name: Check if DH exists
      stat:
        path: /etc/openvpn/easy-rsa/pki/dh.pem
      register: dh_exists

    - name: Generate DH parameters (this takes a while)
      shell: |
        cd /etc/openvpn/easy-rsa
        ./easyrsa --batch gen-dh
      when: not dh_exists.stat.exists
      environment:
        EASYRSA_BATCH: "1"
      async: 600
      poll: 10

    - name: Check if ta.key exists
      stat:
        path: /etc/openvpn/ta.key
      register: ta_exists

    - name: Generate TLS auth key
      shell: openvpn --genkey secret /etc/openvpn/ta.key
      when: not ta_exists.stat.exists

    - name: Copy CA cert to openvpn dir
      copy:
        src: /etc/openvpn/easy-rsa/pki/ca.crt
        dest: /etc/openvpn/ca.crt
        remote_src: true
        mode: '0644'

    - name: Copy server cert
      copy:
        src: /etc/openvpn/easy-rsa/pki/issued/server.crt
        dest: /etc/openvpn/server.crt
        remote_src: true
        mode: '0644'

    - name: Copy server key
      copy:
        src: /etc/openvpn/easy-rsa/pki/private/server.key
        dest: /etc/openvpn/server.key
        remote_src: true
        mode: '0600'

    - name: Copy DH parameters
      copy:
        src: /etc/openvpn/easy-rsa/pki/dh.pem
        dest: /etc/openvpn/dh.pem
        remote_src: true
        mode: '0644'

    - name: Template server config
      template:
        src: "{{ role_path }}/templates/openvpn_server.conf.j2"
        dest: /etc/openvpn/server.conf
        mode: '0600'

    - name: Enable IPv4 forwarding
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        reload: true

    - name: Add NAT masquerade rule
      shell: |
        iptables -t nat -C POSTROUTING -o {{ ansible_default_ipv4.interface | default('eth0') }} -j MASQUERADE 2>/dev/null || \
        iptables -t nat -A POSTROUTING -o {{ ansible_default_ipv4.interface | default('eth0') }} -j MASQUERADE
      changed_when: false

    - name: Save iptables rules
      shell: netfilter-persistent save || iptables-save > /etc/iptables/rules.v4 || true
      changed_when: false
      failed_when: false

    - name: Allow OpenVPN port
      community.general.ufw:
        rule: allow
        port: "{{ openvpn_port | default(1194) }}"
        proto: "{{ openvpn_proto | default('udp') }}"
      when: ufw_enabled | default(false)

    - name: Enable and start OpenVPN
      systemd:
        name: openvpn@server
        enabled: true
        state: started
        daemon_reload: true

    - name: Show OpenVPN status
      debug:
        msg: "OpenVPN server started successfully on port {{ openvpn_port | default(1194) }}/{{ openvpn_proto | default('udp') }}"

  rescue:
    - name: Get OpenVPN service status
      shell: systemctl status openvpn@server 2>&1 || true
      register: ovpn_status
      changed_when: false

    - name: Check for config issues
      shell: cat /etc/openvpn/server.conf 2>&1 || echo "No config file"
      register: ovpn_config
      changed_when: false

    - name: Check PKI files
      shell: ls -la /etc/openvpn/easy-rsa/pki/ 2>&1 || echo "No PKI directory"
      register: pki_files
      changed_when: false

    - name: Check OpenVPN files
      shell: ls -la /etc/openvpn/*.{crt,key,pem,conf} 2>&1 || echo "Missing files"
      register: ovpn_files
      changed_when: false

    - name: Show debug info
      debug:
        msg: |
          OpenVPN service status:
          {{ ovpn_status.stdout }}
          
          PKI files:
          {{ pki_files.stdout }}
          
          OpenVPN files:
          {{ ovpn_files.stdout }}
          
          Docs: man:openvpn(8)
          https://community.openvpn.net/openvpn/wiki/HOWTO

    - name: OpenVPN install failed
      fail:
        msg: "OpenVPN install failed on {{ inventory_hostname }}. Check debug output above."
