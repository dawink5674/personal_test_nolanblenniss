---
- name: Gather service facts
  service_facts:

- name: Detect active native services
  set_fact:
    active_services: "{{ docker_services | selectattr('host_svc', 'defined') | map(attribute='key') | list }}"

- name: Prompt/Select service to dockerize
  set_fact:
    selected_service: "{{ service_key | default('vpn') }}"

- name: Dockerize selected service
  block:
    - name: Pull image
      docker_image:
        name: "{{ item.image }}"
        state: present
      loop: "{{ docker_services | selectattr('key', 'equalto', selected_service) }}"

    - name: Stop native service if active
      systemd:
        name: "{{ item.host_svc }}"
        state: stopped
      when: item.host_svc is defined and ansible_facts.services[item.host_svc | default('')].state == 'running'
      loop: "{{ docker_services | selectattr('key', 'equalto', selected_service) }}"

    - name: Run container
      docker_container:
        name: "{{ selected_service }}-container"
        image: "{{ item.image }}"
        ports: "{{ item.ports | default([]) }}"
        capabilities: "{{ item.caps | default(omit) }}"
        state: started
        detach: yes
      loop: "{{ docker_services | selectattr('key', 'equalto', selected_service) }}"

- name: Show containers
  shell: docker ps -a --filter "name={{ selected_service }}-container"
  register: container_status
  changed_when: false

- name: Debug container status
  debug:
    var: container_status.stdout_lines