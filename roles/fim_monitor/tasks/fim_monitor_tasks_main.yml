---
- name: Ensure session directory
  file:
    path: /tmp/fim_sessions
    state: directory
    mode: '0700'

- name: Generate session ID
  shell: echo -n "{{ fim_path | join(' ') }}" | sha256sum | cut -d' ' -f1
  register: session_id
  changed_when: false

- name: Create session directory
  file:
    path: "/tmp/fim_sessions/{{ session_id.stdout }}"
    state: directory

- name: Create baseline
  shell: find {{ fim_path | join(' ') }} -type f -exec md5sum {} + > "/tmp/fim_sessions/{{ session_id.stdout }}/baseline.txt"
  args:
    creates: "/tmp/fim_sessions/{{ session_id.stdout }}/baseline.txt"

- name: Install FIM cron job (persistent monitoring)
  cron:
    name: "FIM monitor {{ session_id.stdout }}"
    minute: "{{ fim_check_interval.split('/')[-1] if '/' in fim_check_interval else '*/5' }}"
    job: >
      find {{ fim_path | join(' ') }} -type f -exec md5sum {} + >
      /tmp/current_hash.txt;
      diff /tmp/fim_sessions/{{ session_id.stdout }}/baseline.txt /tmp/current_hash.txt >>
      /tmp/fim_sessions/{{ session_id.stdout }}/changes.log || true;
      cp /tmp/current_hash.txt /tmp/fim_sessions/{{ session_id.stdout }}/baseline.txt
  when: fim_choice | int == 1

- name: List monitors
  shell: ls -l /tmp/fim_sessions
  register: monitor_list
  changed_when: false
  when: fim_choice | int == 2

- name: Debug monitor list
  debug:
    msg: "{{ monitor_list.stdout_lines }}"
  when: fim_choice | int == 2

- name: Stop/remove monitor
  block:
    - name: Remove cron
      cron:
        name: "FIM monitor {{ session_id.stdout }}"
        state: absent
    - name: Remove session
      file:
        path: "/tmp/fim_sessions/{{ session_id.stdout }}"
        state: absent
  when: fim_choice | int == 3

- name: View changes log
  shell: tail -f /tmp/fim_sessions/{{ session_id.stdout }}/changes.log
  async: 60
  poll: 5
  when: fim_choice | int == 4