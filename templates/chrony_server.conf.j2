# =============================================================================
# CCDC Master NTP Server - Stratum 10 Orphan Mode
# =============================================================================
# This server becomes the authoritative time source when internet is cut.
# Generated by Ansible for: {{ inventory_hostname }}
# =============================================================================

# -----------------------------------------------------------------------------
# UPSTREAM POOLS (Used when internet is available)
# -----------------------------------------------------------------------------
{% for pool in ntp_pools | default(['pool.ntp.org']) %}
pool {{ pool }} iburst maxsources 4
{% endfor %}

# -----------------------------------------------------------------------------
# ORPHAN MODE: Become Stratum {{ ntp_stratum | default(10) }} when upstreams fail
# -----------------------------------------------------------------------------
# This is the critical setting for CCDC resilience.
# When Red Team cuts internet, this server continues serving time at stratum 10.
local stratum {{ ntp_stratum | default(10) }} orphan

# -----------------------------------------------------------------------------
# ACCESS CONTROL: Allow internal clients
# -----------------------------------------------------------------------------
allow {{ ntp_allow_network | default('172.20.0.0/16') }}

# Deny all other access
deny all

# -----------------------------------------------------------------------------
# TIME STEPPING: Aggressive sync for quick convergence
# -----------------------------------------------------------------------------
# makestep <threshold> <limit>
# threshold: step clock if offset exceeds this many seconds
# limit: -1 means unlimited steps (always step if needed)
makestep {{ ntp_makestep_threshold | default(1.0) }} {{ ntp_makestep_limit | default(-1) }}

# -----------------------------------------------------------------------------
# HARDWARE CLOCK SYNC
# -----------------------------------------------------------------------------
rtcsync

# -----------------------------------------------------------------------------
# DRIFT FILE (Stores clock frequency offset)
# -----------------------------------------------------------------------------
driftfile /var/lib/chrony/drift

# -----------------------------------------------------------------------------
# LOGGING
# -----------------------------------------------------------------------------
logdir /var/log/chrony
log tracking measurements statistics refclocks